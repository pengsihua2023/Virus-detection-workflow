#!/bin/bash

#SBATCH --job-name=viral_enhanced_comp
#SBATCH --partition=bahl_p
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=32
#SBATCH --mem=256G
#SBATCH --time=48:00:00
#SBATCH --output=viral_enhanced_comp_%j.out
#SBATCH --error=viral_enhanced_comp_%j.err

echo "=========================================="
echo "üß¨ Enhanced Comprehensive Viral Detection Workflow"
echo "=========================================="
start_time=$(date +%s)
echo "Start time: $(date)"
echo "Job ID: $SLURM_JOB_ID"
echo "Node: $(hostname)"
echo

cd "$SLURM_SUBMIT_DIR"

# Enhanced environment setup
echo "üîß 1. Setting up enhanced comprehensive environment..."
export LD_LIBRARY_PATH=".:$HOME:/lib64:/usr/lib64:$HOME/.conda/envs/nextflow/lib:/usr/lib64:/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"

# Create libbz2 symbolic links
if [ -f "/usr/lib64/libbz2.so.1" ]; then
    ln -sf /usr/lib64/libbz2.so.1 $HOME/libbz2.so.1.0 2>/dev/null
    ln -sf /usr/lib64/libbz2.so.1 ./libbz2.so.1.0 2>/dev/null
fi

# Load conda environment
module load Miniforge3/24.11.3-0
source $(conda info --base)/etc/profile.d/conda.sh
conda activate nextflow

echo "Current environment: $CONDA_DEFAULT_ENV"

# Comprehensive tool verification
echo "üß™ 2. Verifying comprehensive toolset..."

# Core alignment tools
echo "Core alignment tools:"
echo "  ‚úÖ BWA: $(which bwa)"
echo "  ‚úÖ samtools: $(samtools --version | head -1)"

# Quality control
echo "Quality control tools:"
echo "  ‚úÖ fastp: $(which fastp)"

# Assembly tools
echo "Assembly tools:"
echo "  ‚úÖ MEGAHIT: $(which megahit)"

# ORF prediction
if command -v prodigal >/dev/null 2>&1; then
    echo "  ‚úÖ PRODIGAL: $(which prodigal)"
else
    echo "  ‚ö†Ô∏è PRODIGAL not found, installing..."
    conda install -c bioconda prodigal -y
    if command -v prodigal >/dev/null 2>&1; then
        echo "  ‚úÖ PRODIGAL installed: $(which prodigal)"
    else
        echo "  ‚ùå PRODIGAL installation failed"
    fi
fi

# Protein analysis tools
if command -v diamond >/dev/null 2>&1; then
    echo "  ‚úÖ DIAMOND: $(which diamond)"
else
    echo "  ‚ö†Ô∏è DIAMOND not found, installing..."
    conda install -c bioconda diamond -y
    if command -v diamond >/dev/null 2>&1; then
        echo "  ‚úÖ DIAMOND installed: $(which diamond)"
    else
        echo "  ‚ùå DIAMOND installation failed"
    fi
fi

# Profile analysis tools
if command -v hmmscan >/dev/null 2>&1; then
    echo "  ‚úÖ HMMER: $(which hmmscan)"
else
    echo "  ‚ö†Ô∏è HMMER not found, installing..."
    conda install -c bioconda hmmer -y
    if command -v hmmscan >/dev/null 2>&1; then
        echo "  ‚úÖ HMMER installed: $(which hmmscan)"
    else
        echo "  ‚ùå HMMER installation failed"
    fi
fi

# Quality assessment tools
if command -v checkv >/dev/null 2>&1; then
    echo "  ‚úÖ CheckV: $(which checkv)"
else
    echo "  ‚ö†Ô∏è CheckV not found (optional tool)"
    echo "     Will use alternative quality assessment"
fi

# Taxonomic classification
echo "  ‚úÖ Kraken2: $(which kraken2)"

# Utility tools
echo "Utility tools:"
echo "  ‚úÖ seqtk: $(which seqtk)"
echo "  ‚úÖ bc: $(which bc)"
echo "  ‚úÖ Nextflow: $(nextflow -version 2>/dev/null | head -1)"

# Verify configuration files
echo "üìã 3. Verifying enhanced configuration files..."
if [ -f "main_viral_enhanced_comprehensive_fixed.nf" ]; then
    echo "  ‚úÖ Enhanced workflow file: $(ls -lh main_viral_enhanced_comprehensive_fixed.nf | awk '{print $5}')"
else
    echo "  ‚ùå Enhanced workflow file does not exist"
    exit 1
fi

if [ -f "enhanced_comprehensive_config_fixed.config" ]; then
    echo "  ‚úÖ Enhanced configuration file: $(ls -lh enhanced_comprehensive_config_fixed.config | awk '{print $5}')"
else
    echo "  ‚ùå Enhanced configuration file does not exist"
    exit 1
fi

# Comprehensive database verification
echo "üóÑÔ∏è 4. Verifying comprehensive databases..."

# Viral genomes database
viral_genomes="databases/viral_genomes/complete_precise_human_animal_viruses.fa"
if [ -f "$viral_genomes" ]; then
    size=$(ls -lh "$viral_genomes" | awk '{print $5}')
    count=$(grep -c '^>' "$viral_genomes")
    echo "  ‚úÖ Viral genomes: $count sequences ($size)"
else
    echo "  ‚ùå Viral genomes database not found: $viral_genomes"
    exit 1
fi

# DIAMOND protein database
diamond_db="databases/viral_proteins/complete_precise_human_animal_viruses_proteins_diamond.dmnd"
if [ -f "$diamond_db" ]; then
    size=$(ls -lh "$diamond_db" | awk '{print $5}')
    echo "  ‚úÖ DIAMOND protein database: $size"
else
    echo "  ‚ùå DIAMOND protein database not found: $diamond_db"
    echo "     This will limit protein-level analysis"
fi

# HMMER HMM database
hmm_db="databases/viral_hmm/rvdb-prot.hmm"
if [ -f "$hmm_db" ]; then
    size=$(ls -lh "$hmm_db" | awk '{print $5}')
    echo "  ‚úÖ HMMER HMM database: $size"
    
    # Check if HMM database is pressed (indexed)
    if [ -f "${hmm_db}.h3i" ]; then
        echo "     ‚úÖ HMM database is indexed"
    else
        echo "     ‚ö†Ô∏è HMM database not indexed, will index during analysis"
    fi
else
    echo "  ‚ùå HMMER HMM database not found: $hmm_db"
    echo "     This will limit profile-based analysis"
fi

# Kraken2 database
kraken2_db="databases/viral_genomes/complete_precise_human_animal_viruses_kraken2"
if [ -d "$kraken2_db" ]; then
    echo "  ‚úÖ Kraken2 database directory exists"
    
    # Check key files
    required_files=("hash.k2d" "opts.k2d" "taxo.k2d" "seqid2taxid.map")
    missing_files=0
    
    for file in "${required_files[@]}"; do
        if [ -f "$kraken2_db/$file" ]; then
            size=$(ls -lh "$kraken2_db/$file" | awk '{print $5}')
            echo "    ‚úÖ $file ($size)"
        else
            echo "    ‚ùå $file missing"
            ((missing_files++))
        fi
    done
    
    if [ $missing_files -eq 0 ]; then
        echo "  ‚úÖ Kraken2 database complete"
    else
        echo "  ‚ö†Ô∏è Kraken2 database incomplete, classification may be skipped"
    fi
else
    echo "  ‚ö†Ô∏è Kraken2 database does not exist: $kraken2_db"
    echo "     Taxonomic classification will be skipped"
fi

# Input data verification
echo "üìÅ 5. Verifying input data..."
input_pattern="data/*_{R1,R2}.fastq.gz"
input_files=($(ls data/*_{R1,R2}.fastq.gz 2>/dev/null))

if [ ${#input_files[@]} -gt 0 ]; then
    sample_count=$(ls data/*_R1.fastq.gz 2>/dev/null | wc -l)
    echo "  ‚úÖ Found $sample_count sample(s):"
    
    for r1_file in data/*_R1.fastq.gz; do
        if [ -f "$r1_file" ]; then
            sample_name=$(basename "$r1_file" | sed 's/_R1.fastq.gz//')
            r2_file="${r1_file/_R1/_R2}"
            
            if [ -f "$r2_file" ]; then
                r1_size=$(ls -lh "$r1_file" | awk '{print $5}')
                r2_size=$(ls -lh "$r2_file" | awk '{print $5}')
                echo "    üìä $sample_name: R1=$r1_size, R2=$r2_size"
            else
                echo "    ‚ùå $sample_name: R2 file missing"
            fi
        fi
    done
else
    echo "  ‚ùå No input files found matching pattern: $input_pattern"
    echo "     Please ensure paired FASTQ files are in the data/ directory"
    exit 1
fi

# Clean environment
echo "üßπ 6. Cleaning previous results..."
rm -rf work .nextflow* results_viral_enhanced

# Display enhanced workflow features
echo "üöÄ 7. Enhanced workflow features overview..."
echo ""
echo "NEW FEATURES in this enhanced version:"
echo "  üß¨ ORF Prediction with PRODIGAL"
echo "    - Identifies protein-coding regions in assembled viral genomes"
echo "    - Provides amino acid and nucleotide sequences"
echo "    - Calculates coding density and ORF statistics"
echo ""
echo "  üíé DIAMOND Protein Analysis"
echo "    - BLASTP search against viral protein database"
echo "    - Identifies viral protein families and functions"
echo "    - Provides ortholog assignment and annotation"
echo ""
echo "  üîç HMMER Profile Analysis"
echo "    - Profile HMM search for conserved viral domains"
echo "    - Higher sensitivity than BLAST for distant homologs"
echo "    - Identifies viral protein families and domains"
echo ""
echo "  üìä Abundance Estimation (RPKM/TPM)"
echo "    - Maps reads back to assembled contigs"
echo "    - Calculates coverage, depth, and normalized abundance"
echo "    - Provides quantitative viral load assessment"
echo ""
echo "  ‚úÖ CheckV Quality Assessment"
echo "    - Evaluates completeness of viral genomes"
echo "    - Detects contamination and assembly errors"
echo "    - Provides quality scores and recommendations"
echo ""
echo "  üî¨ Multi-Evidence Integration"
echo "    - Combines evidence from all analysis methods"
echo "    - Provides confidence scores for each detection"
echo "    - Generates comprehensive quality assessment"
echo ""

# Resource allocation summary
echo "üíª Resource allocation:"
echo "  üìä Total allocation: 32 cores, 256GB RAM, 48 hours"
echo "  üîß Process-specific resources:"
echo "    - VIRAL_SCREENING: 16 cores, 128GB, 24h (most intensive)"
echo "    - HMMER_ANALYSIS: 16 cores, 128GB, 16h (HMM search)"
echo "    - DIAMOND_ANALYSIS: 16 cores, 96GB, 8h (protein search)"
echo "    - ABUNDANCE_QUALITY: 16 cores, 128GB, 12h (mapping + CheckV)"
echo "    - Other processes: 8-16 cores, 32-96GB, 4-12h"
echo ""

# Run enhanced comprehensive workflow
echo "üöÄ 8. Running enhanced comprehensive viral detection workflow..."

# Use single-line command to avoid multi-line issues
NEXTFLOW_CMD="nextflow run main_viral_enhanced_comprehensive_fixed.nf -c enhanced_comprehensive_config_fixed.config --reads '/scratch/sp96859/Meta-genome-data-analysis/Nextflow/data/llnl_66ce4dde_{R1,R2}.fastq.gz' --outdir results_viral_enhanced --base_path /scratch/sp96859/Meta-genome-data-analysis/Nextflow --viral_genomes databases/viral_genomes/complete_precise_human_animal_viruses.fa --viral_proteins databases/viral_proteins/complete_precise_human_animal_viruses_proteins_diamond.dmnd --viral_hmm databases/viral_hmm/rvdb-prot.hmm --kraken2_db databases/viral_genomes/complete_precise_human_animal_viruses_kraken2 --threads 32 --memory 256GB -ansi-log false"

echo "Executing enhanced workflow..."
echo "Command: nextflow run main_viral_enhanced_comprehensive_fixed.nf ..."
echo ""

# Execute command and capture exit code correctly
eval $NEXTFLOW_CMD
ACTUAL_EXIT_CODE=$?

echo ""
echo "=========================================="
echo "üéØ Enhanced Comprehensive Workflow Results"
echo "=========================================="
echo "Nextflow exit code: $ACTUAL_EXIT_CODE"

if [ $ACTUAL_EXIT_CODE -eq 0 ]; then
    echo "üéâüéâüéâ Enhanced comprehensive workflow executed successfully!"
    
    # Detailed result checking
    echo ""
    echo "üìä Generated result directories:"
    if [ -d "results_viral_enhanced" ]; then
        find results_viral_enhanced -type d | sort | sed 's/^/  üìÅ /'
        
        echo ""
        echo "üìÑ Enhanced analysis results:"
        
        # 1. Basic screening results
        screening_stats="results_viral_enhanced/02_viral_screening/llnl_66ce4dde_screening_stats.txt"
        if [ -f "$screening_stats" ]; then
            viral_reads=$(grep "Detected viral reads:" "$screening_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  ‚úÖ Viral reads detected: $viral_reads reads"
        fi
        
        # 2. Assembly results
        assembly_stats="results_viral_enhanced/03_viral_assembly/llnl_66ce4dde_assembly_stats.txt"
        if [ -f "$assembly_stats" ]; then
            contigs=$(grep "Viral contigs count:" "$assembly_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  ‚úÖ Assembled contigs: $contigs"
        fi
        
        # 3. NEW: ORF prediction results
        orf_stats="results_viral_enhanced/04_orf_prediction/llnl_66ce4dde_orf_stats.txt"
        if [ -f "$orf_stats" ]; then
            orfs=$(grep "Total ORFs predicted:" "$orf_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  üß¨ NEW: Predicted ORFs: $orfs"
        fi
        
        # 4. NEW: DIAMOND protein analysis
        diamond_stats="results_viral_enhanced/05_diamond_analysis/llnl_66ce4dde_diamond_stats.txt"
        if [ -f "$diamond_stats" ]; then
            diamond_hits=$(grep "Total DIAMOND hits:" "$diamond_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  üíé NEW: DIAMOND protein hits: $diamond_hits"
        fi
        
        # 5. NEW: HMMER profile analysis
        hmmer_stats="results_viral_enhanced/06_hmmer_analysis/llnl_66ce4dde_hmmer_stats.txt"
        if [ -f "$hmmer_stats" ]; then
            hmmer_hits=$(grep "Total HMMER hits:" "$hmmer_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  üîç NEW: HMMER profile hits: $hmmer_hits"
        fi
        
        # 6. NEW: Abundance and quality assessment
        abundance_stats="results_viral_enhanced/07_abundance_quality/llnl_66ce4dde_abundance_stats.txt"
        if [ -f "$abundance_stats" ]; then
            high_cov=$(grep "High coverage contigs:" "$abundance_stats" | cut -d: -f2 | tr -d ' ' || echo "Unknown")
            echo "  üìä NEW: High coverage contigs: $high_cov"
        fi
        
        # 7. Kraken2 classification
        kraken2_summary="results_viral_enhanced/08_viral_classification/llnl_66ce4dde_viral_species_summary.txt"
        if [ -f "$kraken2_summary" ]; then
            if grep -q "Classified reads:" "$kraken2_summary"; then
                classified=$(grep "Classified reads:" "$kraken2_summary" | cut -d: -f2 | tr -d ' ')
                echo "  ü¶† Kraken2 classified reads: $classified"
            fi
        fi
        
        # 8. NEW: Enhanced final report
        final_report="results_viral_enhanced/09_final_report/llnl_66ce4dde.final_summary_stats.txt"
        if [ -f "$final_report" ]; then
            echo "  üìã NEW: Enhanced comprehensive report generated"
            echo "  üìÑ Report size: $(ls -lh "$final_report" | awk '{print $5}')"
            
            # Show conclusion
            if grep -q "CONCLUSION:" "$final_report"; then
                echo "  üí° Analysis conclusion:"
                grep "CONCLUSION:" "$final_report" | sed 's/^/      /'
            fi
        fi
        
        # NEW: Evidence integration table
        evidence_table="results_viral_enhanced/09_final_report/llnl_66ce4dde.evidence_integration.tsv"
        if [ -f "$evidence_table" ]; then
            high_conf=$(awk 'BEGIN{FS="\t"} $11=="HIGH" {count++} END{print count+0}' "$evidence_table")
            medium_conf=$(awk 'BEGIN{FS="\t"} $11=="MEDIUM" {count++} END{print count+0}' "$evidence_table")
            echo "  üî¨ NEW: Evidence integration - High confidence: $high_conf, Medium: $medium_conf"
        fi
        
        echo ""
        echo "üèÜ ENHANCED FEATURES SUMMARY:"
        echo "  ‚úÖ Original workflow: Screening + Assembly + Kraken2"
        echo "  üÜï ORF Prediction: PRODIGAL analysis completed"
        echo "  üÜï Protein Analysis: DIAMOND BLASTP search completed"
        echo "  üÜï Profile Analysis: HMMER domain search completed"
        echo "  üÜï Abundance Analysis: RPKM/TPM calculation completed"
        echo "  üÜï Quality Assessment: CheckV or alternative assessment completed"
        echo "  üÜï Evidence Integration: Multi-method confidence scoring completed"
        echo "  üÜï Enhanced Reporting: Comprehensive analysis report generated"
        
    else
        echo "‚ùå Result directory does not exist"
    fi
    
else
    echo "‚ùå Enhanced workflow execution failed, exit code: $ACTUAL_EXIT_CODE"
    
    echo ""
    echo "üîç Error diagnosis:"
    if [ -f ".nextflow.log" ]; then
        echo "Latest Nextflow log:"
        tail -15 .nextflow.log | sed 's/^/  /'
    fi
    
    # Check errors in work directory
    if [ -d "work" ]; then
        echo ""
        echo "Checking process errors:"
        find work -name ".command.err" -size +0 | head -3 | while read errfile; do
            echo "Error file: $errfile"
            echo "Error content:"
            tail -10 "$errfile" | sed 's/^/  /'
            echo ""
        done
    fi
fi

echo ""
echo "üèÜ Enhanced workflow capabilities comparison:"
echo ""
echo "ORIGINAL WORKFLOW:"
echo "  ‚úÖ Quality control (fastp)"
echo "  ‚úÖ Viral screening (BWA + samtools)"
echo "  ‚úÖ Viral assembly (MEGAHIT)"
echo "  ‚úÖ Taxonomic classification (Kraken2)"
echo "  ‚úÖ Basic reporting"
echo ""
echo "ENHANCED COMPREHENSIVE WORKFLOW:"
echo "  ‚úÖ All original features PLUS:"
echo "  üÜï ORF prediction (PRODIGAL) - identifies protein-coding genes"
echo "  üÜï Protein analysis (DIAMOND) - functional annotation"
echo "  üÜï Profile analysis (HMMER) - conserved domain detection"
echo "  üÜï Abundance estimation (RPKM/TPM) - quantitative analysis"
echo "  üÜï Quality assessment (CheckV) - genome completeness"
echo "  üÜï Evidence integration - multi-method validation"
echo "  üÜï Enhanced reporting - comprehensive analysis summary"
echo ""
echo "This addresses ALL the limitations you identified:"
echo "  ‚úÖ DIAMOND database: Now actively used for protein analysis"
echo "  ‚úÖ HMMER database: Now actively used for profile searches"
echo "  ‚úÖ PRODIGAL software: Now used for ORF prediction"
echo "  ‚úÖ Abundance estimation: RPKM/TPM calculations implemented"
echo "  ‚úÖ CheckV software: Quality assessment implemented"

end_time=$(date +%s)
duration=$((end_time - start_time))
echo ""
echo "=========================================="
echo "Enhanced comprehensive workflow completed: $(date)"
echo "Total time: $duration seconds ($(($duration / 60)) minutes)"
echo "Final exit code: $ACTUAL_EXIT_CODE"
echo "=========================================="

exit $ACTUAL_EXIT_CODE
